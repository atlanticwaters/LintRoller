/**
 * Generate bundled-tokens.ts from local token files.
 *
 * Reads tokens/$metadata.json to discover the full token set,
 * then generates src/ui/bundled-tokens.ts with static imports
 * so esbuild can inline the JSON at build time.
 *
 * Usage: node scripts/generate-token-bundle.js
 */

const fs = require('fs');
const path = require('path');

const TOKENS_DIR = path.join(__dirname, '..', 'tokens');
const OUTPUT_FILE = path.join(__dirname, '..', 'src', 'ui', 'bundled-tokens.ts');

// Read metadata for token set order
const metadataPath = path.join(TOKENS_DIR, '$metadata.json');
if (!fs.existsSync(metadataPath)) {
  console.error('Error: tokens/$metadata.json not found');
  process.exit(1);
}

const metadata = JSON.parse(fs.readFileSync(metadataPath, 'utf-8'));
const tokenSetOrder = metadata.tokenSetOrder;

if (!Array.isArray(tokenSetOrder) || tokenSetOrder.length === 0) {
  console.error('Error: tokenSetOrder is empty or missing in $metadata.json');
  process.exit(1);
}

const imports = [];
const entries = [];
let skipped = 0;

for (const tokenPath of tokenSetOrder) {
  const filePath = path.join(TOKENS_DIR, `${tokenPath}.json`);
  if (!fs.existsSync(filePath)) {
    console.warn(`Warning: Token file not found, skipping: ${tokenPath}.json`);
    skipped++;
    continue;
  }

  // Create a safe variable name from the path
  // e.g. "core/colors" -> "core_colors", "component/beta-list-item-content" -> "component_beta_list_item_content"
  const varName = 'tok_' + tokenPath.replace(/[/-]/g, '_').replace(/[^a-zA-Z0-9_]/g, '');

  imports.push(`import ${varName} from '../../tokens/${tokenPath}.json';`);
  entries.push(`  { path: '${tokenPath}', content: ${varName} as unknown as Record<string, unknown> },`);
}

// Check for $themes.json
const themesPath = path.join(TOKENS_DIR, '$themes.json');
const hasThemes = fs.existsSync(themesPath);

let themesImport = '';
let themesExport = '';
if (hasThemes) {
  themesImport = `import bundledThemes from '../../tokens/$themes.json';`;
  themesExport = `export const BUNDLED_THEME_CONFIGS = bundledThemes as unknown as import('../shared/types').ThemeConfig[];`;
} else {
  themesExport = `export const BUNDLED_THEME_CONFIGS: import('../shared/types').ThemeConfig[] = [];`;
}

const output = `/**
 * Bundled Token Data - AUTO-GENERATED
 *
 * Generated by: node scripts/generate-token-bundle.js
 * Do not edit this file manually.
 */

import type { TokenFileData } from './tokens-loader';

${imports.join('\n')}
${themesImport}

export const BUNDLED_TOKEN_FILES: TokenFileData[] = [
${entries.join('\n')}
];

${themesExport}
`;

fs.writeFileSync(OUTPUT_FILE, output, 'utf-8');
console.log(`Generated ${path.relative(path.join(__dirname, '..'), OUTPUT_FILE)}`);
console.log(`  Token files included: ${entries.length}`);
if (skipped > 0) {
  console.log(`  Token files skipped (not found): ${skipped}`);
}
